# ============================================================================
# FastBidder Docker Compose Configuration
# ============================================================================
#
# CURRENT MODE: HYBRID (Development)
# - Infrastructure (Redis) runs in Docker
# - Application code (Celery worker, FastAPI) runs locally
#
# WHY HYBRID MODE FOR DEVELOPMENT:
# - Faster development (no container rebuild after code changes)
# - Easier debugging (direct access to logs and debugger)
# - Hot-reload works out of the box
#
# TO SWITCH TO PRODUCTION MODE (all in Docker):
# 1. Uncomment the "celery_worker" service below (lines 35-57)
# 2. Uncomment "celery_worker" dependency in flower service (line 75)
# 3. Run: docker-compose up -d
# 4. Stop local Celery worker if running
#
# ============================================================================

services:
  # ============================================================================
  # REDIS - Message Broker & Result Backend
  # ============================================================================
  # Always runs in Docker (both dev and production)

  redis:
    image: redis:7-alpine
    container_name: fastbidder_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --appendfsync everysec
    networks:
      - fastbidder_network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 3

  # ============================================================================
  # CELERY WORKER - Background Task Processor
  # ============================================================================
  # DEVELOPMENT MODE: Commented out - run locally with: make celery-worker
  # PRODUCTION MODE: Uncomment lines below
  # ============================================================================

  # celery_worker:
  #   build:
  #     context: .
  #     dockerfile: docker/Dockerfile
  #   container_name: fastbidder_celery_worker
  #   command: celery -A src.application.tasks worker --loglevel=info
  #   volumes:
  #     - ./src:/app/src
  #     - ./logs:/app/logs
  #     - /tmp/fastbidder:/tmp/fastbidder # For local file storage
  #   environment:
  #     - CELERY_BROKER_URL=redis://redis:6379/0
  #     - CELERY_RESULT_BACKEND=redis://redis:6379/1
  #     - PYTHONPATH=/app
  #   depends_on:
  #     redis:
  #       condition: service_healthy
  #   networks:
  #     - fastbidder_network

  # ============================================================================
  # FLOWER - Celery Monitoring Dashboard
  # ============================================================================
  # Web UI for monitoring Celery tasks at http://localhost:5555
  # Works with both local and containerized Celery workers

  flower:
    image: mher/flower:2.0
    container_name: fastbidder_flower
    command: celery --broker=redis://redis:6379/0 flower --port=5555
    ports:
      - "5555:5555"
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
    depends_on:
      - redis
      # PRODUCTION MODE: Uncomment line below
      # - celery_worker
    networks:
      - fastbidder_network

# ============================================================================
# NETWORKS
# ============================================================================

networks:
  fastbidder_network:
    driver: bridge

# ============================================================================
# VOLUMES
# ============================================================================

volumes:
  redis_data:
    driver: local
